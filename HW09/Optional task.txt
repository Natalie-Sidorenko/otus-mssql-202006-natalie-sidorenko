По каждому файлу из истории удалённых запрос выбирает из временной таблицы версий одну версию какого-то одного файла из этой же папки с наибольшей не превышающей его собственную версией директории и неким свойством RowNum равным 1, где в принципе существуют не превышающие его собственную версии директории и который обязательно восстанавливали. Я понимаю только, что CROSS APPLY SELECT TOP 1 - это избыточно, и то же самое можно сделать просто подзапросом SELECT TOP 1, но в целом у запроса слишком сложная логика, и я недостаточно хорошо поняла её, чтобы упрощать этот запрос.